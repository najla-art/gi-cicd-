name: CI/CD - Create Dockerfile, Build and Push

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Create Dockerfile dynamically
      run: |
        cat << 'EOF' > Dockerfile
        FROM python:3.11-slim
        WORKDIR /app
        COPY requirements.txt .
        RUN pip install --no-cache-dir -r requirements.txt
        COPY app.py .
        EXPOSE 3000
        CMD ["python", "app.py"]
        EOF

    - name: Display Dockerfile (optional)
      run: cat Dockerfile

    - name: Set up QEMU (for multi-arch builds)
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.USER_NAME }}
        password: ${{ secrets.PASSWORD }}

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        platforms: linux/amd64,linux/arm64
        tags: |
          ${{ secrets.USER_NAME }}/bubu-flask-app:latest
          ${{ secrets.USER_NAME }}/bubu-flask-app:${{ github.sha }}
